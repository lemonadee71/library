(()=>{"use strict";class e extends class{constructor(e){this.type=e,this.items=[],this.length=0}addItem(e){this.items.push(e),this.length=this.items.length}removeItem(e){let t=[];this.items.forEach(((a,s)=>{e(a)&&t.push(s-t.length)})),t.length&&t.forEach((e=>this.items.splice(e,1))),this.length=this.items.length}removeAllItems(){this.items=[],this.length=0}sortItems(e){this.items.sort(((t,a)=>e(t,a)?1:-1))}}{constructor(e){super("library"),this.element=e}addToDOM(e){super.addItem(e),this.element.appendChild(e.card)}removeFromDOM(e,t){super.removeItem(t),this.element.removeChild(e.card)}renderBooks(){this.items.map((e=>this.element.appendChild(e.card)))}clearBooks(){[...this.element.children].map((e=>e.remove()))}filterBooks(e){let t=e.charAt(0),a=e.toLowerCase();"#"===t||"@"===t||"+"===t?a=a.slice(1):t="";let s=(e,t)=>{t?e.show():e.hide()};this.items.forEach((e=>{switch(t){case"@":s(e,e.author.toLowerCase().includes(a));break;case"#":s(e,e.status===a);break;case"+":{let t=[...e.tags,...e.categories].map((e=>e.toLowerCase()));s(e,t.includes(a));break}default:s(e,e.title.toLowerCase().includes(a))}}))}sortBooks(e,t=!0){this.clearBooks(),this.sortItems(((a,s)=>t?a[e]>s[e]:a[e]<s[e])),console.log(this.items,e,t),this.renderBooks()}}function t(e){return class extends e{constructor(e){super(e),this.card=document.createElement("div"),this.card.classList.add("card"),this.front=document.createElement("div"),this.back=document.createElement("div"),this.backContent=document.createElement("div"),this.frontElements={},this.backElements={close:document.createElement("span")}}setAttribute(e,t,a,s){t?this[`${e}Elements`][t].setAttribute(a,s):this[e].setAttribute(a,s)}addListener(e,t,a){try{for(let s in a)t?this[`${e}Elements`][t].addEventListener(s,a[s]):this[e].addEventListener(s,a[s])}catch(e){throw e}}addElement(e,t,a){this[`${e}Elements`][t]=this.makeElement(a)}makeElement(e){try{let t;if(e.type&&(t=document.createElement(e.type)),e.class){let a=e.class.split(" ");t.classList.add(...a)}if(e.text){let a=document.createTextNode(e.text);t.appendChild(a)}if(e.attr){let a=e.attr;for(let e in a)a[e]&&t.setAttribute(e,a[e])}if(e.style)for(let a in e.style){let s=a.includes("-")?a.split("-").reduce(((e,t,a)=>a>0?e+t.charAt(0).toUpperCase()+t.slice(1):t),""):a;t.style[s]=e.style[a]}if(e.prop)for(let a in e.prop)t[a]=e.prop[a];if(e.callback){let a=e.callback;for(let e in a)t.addEventListener(e,a[e])}return e.children&&e.children.forEach((e=>{t.appendChild(this.makeElement(e))})),t}catch(e){throw e}}show(){this.card.style.display="block"}hide(){this.card.style.display="none"}initialize(e,t){for(let a in t)this[`${e}Elements`][a]=this.makeElement(t[a])}renderFrontCard(e){for(let e in this.frontElements)this.front.appendChild(this.frontElements[e]);this.front.classList.add(e)}renderBackCard(e){this.backElements.close.classList.add("close"),this.backElements.close.innerHTML="&times;",this.backElements.close.addEventListener("click",(e=>{this.back.style.display="none",e.stopPropagation()}));for(let e in this.backElements)this.backContent.appendChild(this.backElements[e]);this.back.classList.add(e),this.backContent.classList.add("modal-content"),this.back.appendChild(this.backContent),this.back.addEventListener("click",(e=>{Array.from(e.target.classList).includes("modal")&&(this.back.style.display="none")}))}render(e,t){let a="both"!==e?t[0]:"";return"front"!==e&&"both"!==e||(this.renderFrontCard(a||t[0]||""),this.card.appendChild(this.front),"both"===e&&this.front.addEventListener("click",(()=>{this.back.style.display="block"}))),"back"!==e&&"both"!==e||(this.renderBackCard(a||t[1]||""),this.card.appendChild(this.back)),this.card}}}class a{constructor(e){this.id=e.id,this.title=e.title,this.author=e.author,this.description=e.description,this.pageCount=e.pageCount,this.publishedDate=e.publishedDate,this.publisher=e.publisher,this.thumbnail=e.thumbnail,this.rating=e.rating,this.isbn=e.isbn,this.status=e.status||"to read",this.progress=e.progress||0,this.dateRead=e.dateRead||"",this.dateFinished=e.dateFinished||"",this.comment=e.comment||"",this.categories=e.categories||[],this.tags=e.tags||[]}getData(){return{...this}}addTag(e){this.tags.push(e)}removeTag(e){let t=new RegExp(`${e}`,"g");this.tags=this.tags.join("-").replace(t,"").split("-").filter((e=>e))}removeAllTags(){this.tags=[]}}const s=(()=>{let e=window.localStorage,t="data";const a=()=>JSON.parse(e.getItem(t));return{data:e,setKey:e=>{t=e},getItems:a,reset:()=>e.clear(),store:s=>{let i=a();i&&i.push(s),e.setItem(t,JSON.stringify(i||[s]))},update:(s,i)=>{let r,n=a();n.forEach(((e,t)=>{i(e)&&(r=t)})),n[r]=s,e.setItem(t,JSON.stringify(n))},remove:s=>{let i,r=a();r.forEach(((e,t)=>{s(e)&&(i=t)})),r.splice(i,1),e.setItem(t,JSON.stringify(r))}}})();(i=>{let r=i.getElementById("search"),n=i.getElementById("searchModal"),l=i.getElementById("searchForm"),o=i.getElementById("searchResults"),d=i.getElementById("filter"),c=i.getElementById("sorter"),p=i.getElementById("sort-type");const h=new e(i.getElementById("library")),u=e=>{h.filterBooks(e.target.value)},m=e=>{let t,a;"asc"===e.target.value||"dsc"===e.target.value?(t=i.getElementById("sorter").value,a="asc"===e.target.value):(t=e.target.value,a="asc"===i.getElementById("sort-type").value),h.sortBooks(t,a)},g=()=>{n.style.display="block"},y=e=>{"searchModal"===e.target.id&&(n.style.display="none",v())};async function b(e){e.preventDefault();let t=i.getElementById("search-title").value,a=i.getElementById("search-author").value,s=await async function(e){return fetch(`https://www.googleapis.com/books/v1/volumes?q=${e.title}+inauthor:${e.author}`).then((e=>e.json())).then((e=>e.items))}({title:t,author:a});k(s)}const v=()=>{for(;o.firstChild;)o.removeChild(o.lastChild)},k=e=>{v(),e.forEach((e=>{let i=function(e){let s=new(t(a))(e),i={img:{type:"img",attr:{src:s.thumbnail}},title:{type:"p",text:s.title},author:{type:"p",text:s.author||"Unknown"},datePublished:{type:"span",text:s.publishedDate?s.publishedDate.slice(0,4):"Unknown"},rating:{type:"span",text:s.rating||"No rating"},pages:{type:"span",text:s.pageCount||"N/A"},publisher:{type:"p",text:s.publisher||"Unknown"},button:{type:"button",text:"Add Book"},tooltip:{type:"div",class:"tooltip-content",children:[{type:"p",text:s.description}]}};return s.initialize.call(s,"front",i),s.back="",s.render("front",["tooltip"]),s}(E(e));i.addListener("front","button",{click:()=>{let t=f(E(e)),a=!1;h.items.forEach((e=>{e.id===t.id&&(a=!0)})),a?alert("This book is already in your library"):(h.addToDOM(t),s.store(t.getData()),o.removeChild(i.card))}}),o.appendChild(i.card)}))},f=e=>{let i=function(e){let s=new(t(a))(e),i=s.author.split(", ");i=i.length>2?`${i.slice(0,1).join(", ")} et al.`:s.author;const r=e=>{[...document.querySelector(`select[data-id="${s.id}-status"]`).children].forEach((t=>{t.value===e.value?(t.setAttribute("selected","selected"),s.status=t.value):t.removeAttribute("selected")}))},n=(e,t="")=>{let a=document.querySelector(`input[data-id="${s.id}-date${e}"]`),i=new Date,r=`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()}`;a.removeAttribute("value"),a.setAttribute("value",t||r),s[`date${e}`]=t||r};let l={remove:{type:"span",text:"×",class:"close"},cover:{type:"img",class:"cover",attr:{src:`${s.thumbnail||""}`}},title:{type:"p",class:"title",text:`${s.title}`,attr:{style:`font-size: ${s.title.length>32?32/s.title.length*18+"px":"18px"};`}},author:{type:"p",class:"subtitle",text:i,attr:{style:`font-size: ${i.length>20?20/i.length*14+"px":"14px"};`}}},o={title:{type:"p",text:`${s.title}`},author:{type:"p",text:`${s.author||"Unknown"}`},rating:{type:"div",children:[{type:"p",text:"Rating"},{type:"div",children:(()=>{let e=[];for(let t=0;t<5;t++)e.push({type:"span",text:"★",attr:{"data-i":`${t}`},style:{color:t<s.rating?"orange":"gray",cursor:"pointer"},callback:{click:e=>{let t=e.target.getAttribute("data-i");[...e.target.parentElement.children].forEach(((e,a)=>{e.style.color=a<=t?"orange":"gray"})),s.rating=+t+1}}});return e})()}]},progress:{type:"div",style:{position:"relative"},children:[{type:"p",text:"Progress"},{type:"input",class:"progress",attr:{type:"text",placeholder:s.pageCount?`Out of ${s.pageCount} pages`:""},prop:{value:s.progress?`${s.progress}%`:""},style:{width:"115px",display:"none"},callback:{focusout:e=>{let t=e.target,a=t.value;a.includes("%")?s.progress=a.replace("%",""):s.progress=Math.round(+a/+s.pageCount*100),t.value=`${s.progress}%`,t.style.display="none",t.nextSibling.style.display="inline-block",t.nextSibling.firstChild.style.width=`${s.progress}%`,+s.progress>0?"to read"===s.status||"dropped"===s.status?confirm('Set this book\'s status to "reading"')&&(r({value:"reading"}),n("Read")):"read"===s.status&&confirm('Set this book\'s status to "rereading"?')&&r({value:"rereading"}):100==+s.progress&&(r({value:"read"}),n("Finished"))}}},{type:"div",class:"bar",children:[{type:"div",class:"progress",style:{background:"green",cursor:"pointer",width:`${s.progress}%`}}],callback:{dblclick:e=>{let t=e.target;t.className.includes("progress")?(t.parentElement.style.display="none",t.parentElement.previousSibling.style.display="inline"):(t.style.display="none",t.previousSibling.style.display="inline")}}}]},status:{type:"div",children:[{type:"p",text:"Status"},{type:"select",attr:{name:"status","data-id":`${s.id}-status`},children:(()=>{let e=[];return["read","reading","to read","dropped","rereading"].forEach((t=>{e.push({type:"option",text:t.split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "),attr:{value:t,selected:s.status===t?"selected":""}})})),e})(),callback:{change:e=>{r(e.target),"reading"===e.target.value?n("Read"):"read"===e.target.value&&n("Finished")}}}]},desc:{type:"div",children:[{type:"p",text:"Synopsis"},{type:"p",class:"description",text:s.description&&s.description.length<200?`${s.description}`:"",children:s.description&&s.description.length>200?[{type:"span",text:`${s.description.slice(0,200)}`},{type:"span",text:"...",attr:{"data-name":`${s.id}-dots`}},{type:"span",text:`${s.description.slice(200,s.description.length)}`,attr:{"data-name":`${s.id}-moreTxt`,style:"display: none;"}},{type:"span",text:" Read more",attr:{"data-name":`${s.id}-moreBtn`,style:"font-weight: bold; cursor: pointer;"},callback:{click:()=>{let e=document.querySelector(`span[data-name="${s.id}-dots"]`),t=document.querySelector(`span[data-name="${s.id}-moreTxt"]`),a=document.querySelector(`span[data-name="${s.id}-moreBtn"]`);"none"===e.style.display?(e.style.display="inline",a.innerHTML=" Read more",t.style.display="none"):(e.style.display="none",a.innerHTML=" Read less",t.style.display="inline")}}}]:[]},{type:"p",text:`First published ${s.publishedDate.slice(0,4)||"N/A"} by ${s.publisher||"Unknown"}`}]},comment:{type:"div",children:[{type:"p",text:"Review"},{type:"textarea",prop:{textContent:s.comment||""},callback:{keydown:e=>{s.comment=e.target.value},focusout:e=>{s.comment=e.target.value}}}]},dateRead:{type:"input",attr:{type:"date",value:s.dateRead||"","data-id":`${s.id}-dateRead`},callback:{change:e=>{"to read"!==s.status&&"dropped"!==s.status||confirm('Set this book\'s status to "reading"?')&&(r({value:"reading"}),n("Read")),n("Read",e.target.value)}}},dateFinished:{type:"input",attr:{type:"date",value:s.dateFinished||"","data-id":`${s.id}-dateFinished`},callback:{change:e=>{"read"!==s.status&&"rereading"!==s.status&&confirm('Set this book\'s status to "read"?')&&(r({value:"read"}),n("Finished")),n("Finished",e.target.value)}}},tags:{type:"div",children:[{type:"input",attr:{placeholder:"Add tag"},callback:{keypress:e=>{if("Enter"===e.code){let t=e.target.value;if(s.tags.includes(t))alert("Tag already added");else{let a=((e,t="tag",a="span")=>{let i=document.createElement(a),r=document.createTextNode(e),n=document.createElement("span");return n.innerHTML="&times;",n.style.cursor="pointer",n.addEventListener("click",(()=>{s.removeTag(e),i.parentElement.removeChild(i)})),i.append(r,n),i.classList.add(t),i})(t);s.addTag(t),e.target.nextSibling.appendChild(a),e.target.value=""}}}}},{type:"div",children:(()=>{let e=[];return[...s.categories,...s.tags].forEach((t=>{e.push({type:"span",class:"tag",text:t,children:[{type:"span",style:{cursor:"pointer"},prop:{innerHTML:"&times;"},callback:{click:e=>{e.target.parentElement.remove(),s.removeTag(t)}}}]})})),e})()}]}};return s.initialize.call(s,"front",l),s.initialize.call(s,"back",o),s.render("both",["front","modal"]),s}(e);return i.addListener("front","remove",{click:e=>{e.stopPropagation(),confirm("Are you sure you want to remove this book from your library?")&&(i.card.remove(),s.remove((e=>e.id===i.id)),h.removeItem((e=>e.id===i.id)))}}),i.addListener("back","",{change:()=>s.update(i.getData(),(e=>e.id===i.id)),keydown:()=>s.update(i.getData(),(e=>e.id===i.id)),keypress:()=>s.update(i.getData(),(e=>e.id===i.id)),focusout:()=>s.update(i.getData(),(e=>e.id===i.id))}),i.addListener("back","rating",{click:()=>s.update(i.getData(),(e=>e.id===i.id))}),i.addListener("back","tags",{click:()=>s.update(i.getData(),(e=>e.id===i.id))}),i},E=e=>({id:e.id,title:e.volumeInfo.title,author:e.volumeInfo.authors?e.volumeInfo.authors.join(", "):"Unknown",description:e.volumeInfo.description,rating:e.volumeInfo.averageRating,pageCount:e.volumeInfo.pageCount,publishedDate:e.volumeInfo.publishedDate,publisher:e.volumeInfo.publisher,thumbnail:e.volumeInfo.imageLinks?e.volumeInfo.imageLinks.thumbnail:"",rating:e.volumeInfo.averageRating,categories:e.volumeInfo.categories});return{initialize:()=>{r.addEventListener("click",g),n.addEventListener("click",y),l.addEventListener("submit",b),d.addEventListener("keyup",u),c.addEventListener("change",m),p.addEventListener("change",m),(()=>{let e=s.getItems();e&&e.forEach((e=>h.addToDOM(f(e))))})()}}})(document).initialize()})();